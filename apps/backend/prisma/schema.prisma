// apps/backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
  INSTRUCTOR
  GUEST
}

enum QuestionType {
  MCQ
  NUMERICAL
  TEXT // Future use
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String   // Hashed
  role      Role     @default(STUDENT)
  avatar    String?  // Profile picture URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Extended Profile
  bio           String?
  expertise     String?
  experience    String?
  linkedin      String?
  studentStatus String?
  interests     String?
  
  // OTP for critical actions
  deleteOtp        String?
  deleteOtpExpires DateTime?
  loginOtp         String?
  loginOtpExpires  DateTime?

  enrollments      Enrollment[]
  attempts         Attempt[]
  completedLessons LessonProgress[]
  courses          Course[]  @relation("InstructorCourses")
  notifications    Notification[]
  reviews          Review[]
  notes            Note[]
  comments         LessonComment[]
  payments         Payment[]

  phoneNumber      String?
  
  // Finance
  walletBalance    Float    @default(0)
  totalEarnings    Float    @default(0)
  bankDetails      String?  // JSON: { type: 'UPI'|'BANK', value: ... }
  
  payouts          Payout[]
  earnings         EarningsLedger[]
}

model Payout {
  id            String   @id @default(uuid())
  amount        Float
  status        String   @default("REQUESTED") // REQUESTED, PROCESSED, REJECTED
  transactionRef String? // Bank Ref ID
  
  instructorId  String
  instructor    User     @relation(fields: [instructorId], references: [id])
  
  requestedAt   DateTime @default(now())
  processedAt   DateTime?
}

model EarningsLedger {
  id            String   @id @default(uuid())
  amount        Float
  type          String   // COURSE_SALE, WITHDRAWAL, ADJUSTMENT
  description   String?
  
  instructorId  String
  instructor    User     @relation(fields: [instructorId], references: [id])
  
  courseId      String?
  course        Course?  @relation(fields: [courseId], references: [id])
  
  createdAt     DateTime @default(now())
}

model Note {
  id        String   @id @default(uuid())
  content   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId]) // One note per lesson per user
}

model LearningPath {
  id          String   @id @default(uuid())
  title       String
  description String?
  courses     Course[] @relation("PathCourses")
  createdAt   DateTime @default(now())
}

model Course {
  id            String   @id @default(uuid())
  title         String
  description   String?
  level         CourseLevel @default(BEGINNER)
  prerequisites String?  // JSON or text list of prereqs
  price         Float    @default(0)  // Total price (VIDEO) or calculated total (LIVE)
  pricePerClass Float?   // Only for LIVE courses
  discountedPrice Float? // Optional discounted total for LIVE courses
  totalClasses  Int?     // Number of classes for LIVE courses
  startDate     DateTime? // Course start date (required for LIVE)
  endDate       DateTime? // Course end date (required for LIVE)
  isPublished   Boolean  @default(false)
  publishedAt   DateTime? // When it was first published
  
  // New Fields for Live Classes
  maxStudents     Int?     // Max enrollment limit for LIVE courses
  type            String   @default("VIDEO") // VIDEO or LIVE
  meetingPlatform String?  // ZOOM, MEET
  meetingLink     String?
  schedule        String?

  liveSettings    LiveClassSettings?
  schedules       ClassSchedule[]

  instructorId  String?
  instructor    User?    @relation("InstructorCourses", fields: [instructorId], references: [id])
  
  modules       Module[]
  tests         Test[]
  enrollments   Enrollment[]
  learningPaths LearningPath[] @relation("PathCourses")
  reviews       Review[]
  payments      Payment[]
  earnings      EarningsLedger[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LiveClassSettings {
  id              String  @id @default(uuid())
  courseId        String  @unique
  course          Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  platform        String  @default("ZOOM")
  meetingLink     String?
  scheduleNote    String? // e.g. "Mon, Wed, Fri at 8 PM IST"
  difficulty      String? // If different from CourseLevel
}

model ClassSchedule {
  id        String   @id @default(uuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // For Calendar Generation
  dayOfWeek Int?     // 1=Mon, 7=Sun (ISO)
  startTime String   // "20:00"
  duration  Int      @default(60) // minutes
  
  createdAt DateTime @default(now())
}

model Module {
  id        String   @id @default(uuid())
  title     String
  order     Int
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  lessons   Lesson[]
  tests     Test[]
}

model Lesson {
  id        String   @id @default(uuid())
  title     String
  content   String?  // Text content or video URL (Legacy or generic)
  type      String   // VIDEO, TEXT
  
  // New Optional Fields
  videoUrl      String? // For YouTube/Vimeo links
  summary       String? // Text summary of the lesson
  attachmentUrl String? // Link to PDF/Doc

  duration  Int?     // In minutes
  order     Int      @default(0)
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id])
  progress  LessonProgress[]
  notes     Note[]
  comments  LessonComment[]
}

model LessonProgress {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  completedAt DateTime @default(now())

  @@unique([userId, lessonId])
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  enrolledAt DateTime @default(now())

  // Notification Preferences
  notify15m   Boolean @default(true)
  notify30m   Boolean @default(false)
  notify1h    Boolean @default(false)
  notifySMS   Boolean @default(false)
  notifyEmail Boolean @default(true)
}

model Test {
  id        String   @id @default(uuid())
  title     String
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  
  // Optional: Link to a Module (for ordering within curriculum)
  moduleId  String?
  module    Module?  @relation(fields: [moduleId], references: [id])
  
  questions Question[]
  attempts  Attempt[]
  duration  Int      @default(60)
  order     Int      @default(0) // Order within the module or course
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Question {
  id          String       @id @default(uuid())
  text        String
  type        QuestionType @default(MCQ)
  explanation String?      // For "Why did this work?" reflection
  imageUrl    String?      // URL for question image
  testId      String
  test        Test         @relation(fields: [testId], references: [id])
  options     Option[]
  points      Int          @default(1)
}

model Option {
  id         String   @id @default(uuid())
  text       String
  imageUrl   String?  // URL for option image
  isCorrect  Boolean
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
}

model Attempt {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  testId    String
  test      Test     @relation(fields: [testId], references: [id])
  score     Int
  passed    Boolean  @default(false)
  startedAt DateTime @default(now())
  completedAt DateTime?
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  type      String   @default("NEWS") // NEWS, COURSE_UPDATE
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Review {
  id        String   @id @default(uuid())
  rating    Int      @default(5)
  comment   String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LessonComment {
  id        String   @id @default(uuid())
  content   String
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  
  parentId  String?  // For nested replies
  parent    LessonComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   LessonComment[] @relation("CommentReplies")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id        String   @id @default(uuid())
  amount    Float
  currency  String   @default("INR")
  status    String   // SUCCESS, FAILED, PENDING, REFUNDED
  provider  String   @default("RAZORPAY")
  
  // Provider IDs for reconciliation
  providerPaymentId String?
  providerOrderId   String?
  signature         String?

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
