// apps/backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum Role {
  STUDENT
  ADMIN
  INSTRUCTOR
}

enum QuestionType {
  MCQ
  NUMERICAL
  TEXT // Future use
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String   // Hashed
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  enrollments      Enrollment[]
  attempts         Attempt[]
  completedLessons LessonProgress[]
  courses          Course[]  @relation("InstructorCourses")
}

model LearningPath {
  id          String   @id @default(uuid())
  title       String
  description String?
  courses     Course[] @relation("PathCourses")
  createdAt   DateTime @default(now())
}

model Course {
  id            String   @id @default(uuid())
  title         String
  description   String?
  level         CourseLevel @default(BEGINNER)
  prerequisites String?  // JSON or text list of prereqs
  price         Float    @default(0)
  isPublished   Boolean  @default(false)
  instructorId  String?
  instructor    User?    @relation("InstructorCourses", fields: [instructorId], references: [id])
  
  modules       Module[]
  tests         Test[]
  enrollments   Enrollment[]
  learningPaths LearningPath[] @relation("PathCourses")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Module {
  id        String   @id @default(uuid())
  title     String
  order     Int
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  lessons   Lesson[]
}

model Lesson {
  id        String   @id @default(uuid())
  title     String
  content   String?  // Text content or video URL
  type      String   // VIDEO, TEXT
  duration  Int?     // In minutes
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id])
  progress  LessonProgress[]
}

model LessonProgress {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  completedAt DateTime @default(now())

  @@unique([userId, lessonId])
}

model Enrollment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  enrolledAt DateTime @default(now())
}

model Test {
  id        String   @id @default(uuid())
  title     String
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  questions Question[]
  attempts  Attempt[]
}

model Question {
  id          String       @id @default(uuid())
  text        String
  type        QuestionType @default(MCQ)
  explanation String?      // For "Why did this work?" reflection
  testId      String
  test        Test         @relation(fields: [testId], references: [id])
  options     Option[]
  points      Int          @default(1)
}

model Option {
  id         String   @id @default(uuid())
  text       String
  isCorrect  Boolean
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
}

model Attempt {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  testId    String
  test      Test     @relation(fields: [testId], references: [id])
  score     Int
  passed    Boolean  @default(false)
  startedAt DateTime @default(now())
  completedAt DateTime?
}
